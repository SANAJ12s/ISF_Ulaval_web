import{_ as ue,f as d,g as de,h as ce,i as me,q as ve,j as ge,k as K,l as fe,m as pe,p as be,o as n,c as r,a as s,s as _e,u as ye,t as u,v as A,x as L,y as W,d as V,F as T,r as N,b as _,I as he,A as U,D,E as H,z as B,G as ke,n as je,J as we,K as Ae,L as Ve,H as Ce,M as xe}from"./index-78fee844.js";const Ue={class:"admin"},Pe={class:"container py-5"},Le={class:"d-flex align-items-center justify-content-between flex-wrap gap-2 mb-4"},Re={class:"card mb-4"},Ee={class:"h5 fw-bold mb-3"},Fe={class:"row g-3"},Ie={class:"col-md-6"},Se={class:"col-md-6"},Me={class:"col-12"},$e=["disabled"],Te={key:0,class:"img-grid mt-3"},Ne=["src"],De={class:"img-actions"},Be={class:"muted small"},Oe=["onClick","disabled"],qe={key:1,class:"img-grid mt-3"},ze=["src"],Ge={class:"img-actions"},Ke={class:"muted small"},We=["onClick","disabled"],He={key:2,class:"uploadBox mt-3"},Je={class:"muted"},Ze={class:"progressLine"},Qe=["disabled"],Xe={class:"col-md-6"},Ye={class:"col-12"},es={class:"col-md-6"},ss={class:"col-md-6"},ts={class:"col-12 d-flex flex-wrap gap-2"},ls=["disabled"],as=["disabled"],os={key:0,class:"text-danger mb-0"},is={class:"card"},ns={class:"d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3"},rs={class:"badge"},us={key:0,class:"empty"},ds={key:1,class:"empty"},cs={key:2,class:"list"},ms={class:"info"},vs={class:"top"},gs={class:"name"},fs={class:"meta"},ps={class:"pill"},bs={class:"pill muted-pill"},_s={key:0,class:"desc"},ys={class:"links"},hs=["href"],ks={key:1,class:"muted"},js={key:2,class:"muted"},ws={class:"actions"},As=["onClick","disabled"],Vs=["onClick","disabled"],Cs={__name:"AdminProjects",setup(xs){const R=d(!0),m=d(!1),v=d(!1),c=d(""),O=d([]);let E=null;const f=d(null),F=d(null),p=d([]),y=d([]),C=d([]),j=d(0),w=d(0),h=d(0),x=d([]),a=de({title:"",status:"En cours",summary:"",images:[],link:"",order:1,isVisible:!0}),I=ce(()=>[...O.value].sort((l,e)=>(l.order??999)-(e.order??999)));function J(l){return String(l||"file").normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9._-]/g,"_")}function S(){F.value&&(F.value.value="")}function P(){for(const l of C.value)URL.revokeObjectURL(l);C.value=[]}function q(){a.title="",a.status="En cours",a.summary="",a.images=[],a.link="",a.order=1,a.isVisible=!0,p.value=[],y.value=[],P(),S(),c.value=""}me(()=>{const l=ve(K(U,"projects"),ge("order","asc"));E=fe(l,e=>{O.value=e.docs.map(i=>{const t=i.data()||{},o=Array.isArray(t.images)?t.images:t.image?[t.image]:[];return{id:i.id,...t,images:o}}),R.value=!1},e=>{console.error(e),c.value="Erreur Firestore (projects). VÃ©rifie rules + config Firebase.",R.value=!1})}),pe(()=>{E&&E(),P()});function Z(l){c.value="";const e=Array.from(l.target.files||[]);if(e.length){for(const i of e){if(!((i.type||"").toLowerCase().startsWith("image/")||/\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(i.name)))continue;p.value.push(i);const g=URL.createObjectURL(i);C.value.push(g),y.value.push({url:g,name:i.name})}S()}}function Q(l){p.value.splice(l,1);const e=y.value.splice(l,1)[0];e!=null&&e.url&&(URL.revokeObjectURL(e.url),C.value=C.value.filter(i=>i!==e.url))}function X(l){a.images.splice(l,1)}function Y(){for(const l of x.value)try{l.cancel()}catch{}x.value=[],v.value=!1,j.value=0,w.value=0,h.value=0,c.value="Upload annulÃ©."}async function ee(l,e=2e4){return await Promise.race([new Promise((i,t)=>{l.on("state_changed",()=>{},o=>t(o),async()=>{try{const o=await xe(l.snapshot.ref);i(o)}catch(o){t(o)}})}),new Promise((i,t)=>setTimeout(()=>t(new Error("Upload timeout. VÃ©rifie Storage rules + connexion.")),e))])}async function se(l){var i;if(!p.value.length)return;v.value=!0,j.value=p.value.length,w.value=0,h.value=0,x.value=[];const e=[];try{for(let t=0;t<p.value.length;t++){const o=p.value[t],g=`${Date.now()}_${Math.random().toString(16).slice(2)}`,b=`projects/${l}/${g}_${J(o.name)}`,k=we(Ae,b),M=Ve(k,o);x.value.push(M),M.on("state_changed",$=>{const ne=$.totalBytes>0?Math.round($.bytesTransferred/$.totalBytes*100):0,re=Math.round((t+ne/100)/j.value*100);h.value=Math.min(99,Math.max(0,re))});const ie=await ee(M,25e3);e.push(ie),w.value+=1,h.value=Math.round(w.value/j.value*100)}for(const t of e)a.images.includes(t)||a.images.push(t);await H(B(U,"projects",l),{images:a.images,image:((i=a.images)==null?void 0:i[0])||"",updatedAt:D()}),p.value=[],y.value=[],P()}finally{v.value=!1,x.value=[],j.value=0,w.value=0,h.value=0}}async function te(){var e,i,t,o,g;if(c.value="",!((e=a.title)!=null&&e.trim())){c.value="Le titre est obligatoire.";return}m.value=!0;const l={title:a.title.trim(),status:a.status,summary:((i=a.summary)==null?void 0:i.trim())||"",link:((t=a.link)==null?void 0:t.trim())||"",order:Number.isFinite(a.order)?Number(a.order):999,isVisible:!!a.isVisible,updatedAt:D()};try{let b=f.value;if(f.value?await H(B(U,"projects",f.value),{...l,images:Array.isArray(a.images)?a.images:[],image:((o=a.images)==null?void 0:o[0])||""}):b=(await ke(K(U,"projects"),{...l,images:Array.isArray(a.images)?a.images:[],image:((g=a.images)==null?void 0:g[0])||"",createdAt:D()})).id,p.value.length)try{await se(b)}catch(k){console.error(k),c.value="Le projet est enregistrÃ©, mais lâ€™upload des images a Ã©chouÃ©. "+((k==null?void 0:k.message)||"VÃ©rifie Storage rules: /projects/** write admin.")}f.value=null,q()}catch(b){console.error(b),c.value=(b==null?void 0:b.message)||"Erreur lors de lâ€™enregistrement."}finally{m.value=!1}}function le(l){f.value=l.id,a.title=l.title||"",a.status=l.status||"En cours",a.summary=l.summary||"",a.images=Array.isArray(l.images)?[...l.images]:l.image?[l.image]:[],a.link=l.link||"",a.order=Number.isFinite(l.order)?l.order:999,a.isVisible=l.isVisible!==!1,p.value=[],y.value=[],P(),S(),c.value=""}function z(){f.value=null,q()}async function ae(l){c.value="";try{await Ce(B(U,"projects",l)),f.value===l&&z()}catch(e){console.error(e),c.value=(e==null?void 0:e.message)||"Erreur lors de la suppression."}}function oe(l){return l?l.length>40?l.slice(0,40)+"â€¦":l:""}function G(l){return l?Array.isArray(l.images)&&l.images.length?l.images[0]:l.image?l.image:"":""}return(l,e)=>{const i=be("router-link");return n(),r("main",Ue,[s("div",Pe,[s("div",Le,[e[7]||(e[7]=s("div",null,[s("h1",{class:"title"},"Gestion â€” Projets"),s("p",{class:"subtitle"},"Ajoute, modifie et supprime les projets affichÃ©s sur le site.")],-1)),_e(i,{class:"btn-back",to:"/admin"},{default:ye(()=>[...e[6]||(e[6]=[V("â† Retour au dashboard",-1)])]),_:1})]),s("div",Re,[s("h2",Ee,u(f.value?"Modifier un projet":"Nouveau projet"),1),s("div",Fe,[s("div",Ie,[e[8]||(e[8]=s("label",{class:"form-label"},"Titre",-1)),A(s("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>a.title=t),class:"form-control",placeholder:"Ex: Filtration dâ€™eau potable"},null,512),[[L,a.title,void 0,{trim:!0}]])]),s("div",Se,[e[10]||(e[10]=s("label",{class:"form-label"},"Statut",-1)),A(s("select",{"onUpdate:modelValue":e[1]||(e[1]=t=>a.status=t),class:"form-select"},[...e[9]||(e[9]=[s("option",{value:"En cours"},"En cours",-1),s("option",{value:"TerminÃ©"},"TerminÃ©",-1),s("option",{value:"Ã€ venir"},"Ã€ venir",-1)])],512),[[W,a.status]])]),s("div",Me,[e[11]||(e[11]=s("label",{class:"form-label"},"Images (upload)",-1)),s("input",{ref_key:"fileInput",ref:F,class:"form-control",type:"file",multiple:"",accept:"image/*",onChange:Z,disabled:m.value||v.value},null,40,$e),e[12]||(e[12]=s("small",{class:"muted d-block mt-2"},[V(" âœ… Les images seront uploadÃ©es aprÃ¨s avoir cliquÃ© sur "),s("b",null,"Ajouter/Enregistrer projet"),V(". "),s("br"),V(" Si Storage bloque, le projet est quand mÃªme enregistrÃ© (sans photo) et tu verras une erreur claire. ")],-1)),y.value.length?(n(),r("div",Te,[(n(!0),r(T,null,N(y.value,(t,o)=>(n(),r("div",{key:t.url,class:"img-card"},[s("img",{src:t.url,alt:"",class:"img-preview"},null,8,Ne),s("div",De,[s("span",Be,u(o===0?"Cover (pending)":`Pending ${o+1}`),1),s("button",{class:"btn-small danger",type:"button",onClick:g=>Q(o),disabled:m.value||v.value}," Retirer ",8,Oe)])]))),128))])):_("",!0),a.images.length?(n(),r("div",qe,[(n(!0),r(T,null,N(a.images,(t,o)=>(n(),r("div",{key:t+o,class:"img-card"},[s("img",{src:t,alt:"",class:"img-preview"},null,8,ze),s("div",Ge,[s("span",Ke,u(o===0?"Cover":`Image ${o+1}`),1),s("button",{class:"btn-small danger",type:"button",onClick:g=>X(o),disabled:m.value||v.value}," Retirer ",8,We)])]))),128))])):_("",!0),v.value?(n(),r("div",He,[s("div",Je," Upload en coursâ€¦ "+u(w.value)+"/"+u(j.value)+" ("+u(h.value)+"%) ",1),s("div",Ze,[s("div",{class:"progressFill",style:he({width:h.value+"%"})},null,4)]),s("button",{class:"btn-small danger mt-2",type:"button",onClick:Y,disabled:m.value}," Annuler lâ€™upload ",8,Qe)])):_("",!0)]),s("div",Xe,[e[13]||(e[13]=s("label",{class:"form-label"},"Lien (optionnel)",-1)),A(s("input",{"onUpdate:modelValue":e[2]||(e[2]=t=>a.link=t),class:"form-control",placeholder:"https://..."},null,512),[[L,a.link,void 0,{trim:!0}]])]),s("div",Ye,[e[14]||(e[14]=s("label",{class:"form-label"},"RÃ©sumÃ©",-1)),A(s("textarea",{"onUpdate:modelValue":e[3]||(e[3]=t=>a.summary=t),class:"form-control",rows:"3",placeholder:"Courte description du projet..."},null,512),[[L,a.summary,void 0,{trim:!0}]])]),s("div",es,[e[15]||(e[15]=s("label",{class:"form-label"},"Ordre dâ€™affichage",-1)),A(s("input",{"onUpdate:modelValue":e[4]||(e[4]=t=>a.order=t),type:"number",class:"form-control",placeholder:"1"},null,512),[[L,a.order,void 0,{number:!0}]]),e[16]||(e[16]=s("small",{class:"muted"},"Plus petit = affichÃ© en premier.",-1))]),s("div",ss,[e[18]||(e[18]=s("label",{class:"form-label"},"Afficher sur le site",-1)),A(s("select",{"onUpdate:modelValue":e[5]||(e[5]=t=>a.isVisible=t),class:"form-select"},[...e[17]||(e[17]=[s("option",{value:!0},"Oui",-1),s("option",{value:!1},"Non",-1)])],512),[[W,a.isVisible]])]),s("div",ts,[s("button",{class:"btn-primary",type:"button",onClick:te,disabled:m.value||v.value},u(m.value?"...":f.value?"Enregistrer projet":"Ajouter projet"),9,ls),f.value?(n(),r("button",{key:0,class:"btn-ghost",type:"button",onClick:z,disabled:m.value||v.value}," Annuler ",8,as)):_("",!0)]),c.value?(n(),r("p",os,u(c.value),1)):_("",!0)])]),s("div",is,[s("div",ns,[e[19]||(e[19]=s("h2",{class:"h5 fw-bold mb-0"},"Projets",-1)),s("span",rs,u(I.value.length)+" total",1)]),R.value?(n(),r("div",us,"Chargementâ€¦")):I.value.length===0?(n(),r("div",ds," Aucun projet pour le moment. Ajoute-en un ðŸ‘† ")):(n(),r("div",cs,[(n(!0),r(T,null,N(I.value,t=>{var o;return n(),r("div",{key:t.id,class:"item"},[s("div",ms,[s("div",vs,[s("div",gs,u(t.title),1),s("div",fs,[s("span",ps,u(t.status),1),s("span",bs,"Ordre: "+u(t.order??999),1),s("span",{class:je(["pill",t.isVisible?"ok":"off"])},u(t.isVisible?"Visible":"MasquÃ©"),3)])]),t.summary?(n(),r("p",_s,u(t.summary),1)):_("",!0),s("div",ys,[t.link?(n(),r("a",{key:0,class:"link",href:t.link,target:"_blank",rel:"noreferrer"},"Ouvrir le lien",8,hs)):_("",!0),G(t)?(n(),r("span",ks,"ðŸ–¼ï¸ Cover: "+u(oe(G(t))),1)):_("",!0),(((o=t.images)==null?void 0:o.length)||0)>1?(n(),r("span",js," + "+u(t.images.length-1)+" autres image(s) ",1)):_("",!0)])]),s("div",ws,[s("button",{class:"btn-small",type:"button",onClick:g=>le(t),disabled:m.value||v.value},"Modifier",8,As),s("button",{class:"btn-small danger",type:"button",onClick:g=>ae(t.id),disabled:m.value||v.value}," Supprimer ",8,Vs)])])}),128))])),e[20]||(e[20]=s("p",{class:"hint"},[V(" ðŸ”§ Firestore : "),s("code",null,"projects"),V(" â€” Storage : "),s("code",null,"projects/{projectId}/...")],-1))])])])}}},Ps=ue(Cs,[["__scopeId","data-v-4f1e6ba8"]]);export{Ps as default};
